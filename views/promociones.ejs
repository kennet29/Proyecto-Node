<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="shortcut icon" href="#">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Promociones</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/css/bootstrap.min.css" integrity="sha384-DhY6onE6f3zzKbjUPRc2hOzGAdEf4/Dz+WJwBvEYL/lkkIsI3ihufq9hk9K4lVoK" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<!-- Luego, cargar Bootstrap -->
<script src="https://kit.fontawesome.com/433c5e385c.js" crossorigin="anonymous"></script>
<% for (let i = 0; i < cssPaths.length; i++) { %>
    <link rel="stylesheet" type="text/css" href="<%= cssPaths[i] %>">
  <% } %>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.2/dist/sweetalert2.min.css"> 
    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap5.min.css">
    <style>
        .Create
        {
        background-color: #4a4a4a;
        margin-left: 45%;
        width: 60px;
        height: 60px;
        border-radius: 50px;
        
        }
        
        </style>
</head>
<body>
    <div class="container-fluid">
        <button id="btnCrear" class="btn btn-dark mt-2 Create"> <i class="fa-solid fa-circle-plus fa-bounce fa-2xl"></i> </button>
        <div class="row shadow-lg p-3 mb-5">
            <div class="col">
                <table id="TablaProm" class="table table-striped table-bordered" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Promoción</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Final</th>
                            <th>Descuento</th>
                            <th>Descripción</th>
                            <th>Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para CRUD -->
    <div id="modalCRUD" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"></h5>
                </div>
                <form id="formPromociones">
                    <div class="modal-body">
                        <input id="codigo" hidden>

                        <label for="" class="col-form-label">Promoción:</label>
                        <input type="text" class="form-control" id="nombre">

                        <label for="" class="col-form-label">Fecha Inicio</label>
                        <input id="fechaInicio" type="date" class="form-control">

                        <label for="" class="col-form-label">Fecha Final</label>
                        <input id="fechaFinal" type="date" class="form-control">

                        <label for="" class="col-form-label">Descuento</label>
                        <input id="descuento" type="text" class="form-control">

                        <label for="" class="col-form-label">Descripción</label>
                        <input id="descripcion" type="text" class="form-control">

                        <label for="" class="col-form-label">Estado</label>
                        <input id="estado" type="text" class="form-control">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="submit" id="btnGuardar" class="btn btn-dark">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Agrega aquí tus enlaces a las bibliotecas JavaScript necesarias, como jQuery, DataTables y SweetAlert2 -->
    
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/js/bootstrap.bundle.min.js" integrity="sha384-BOsAfwzjNJHrJ8cZidOg56tcQWfp6y72vEJ8xQ9w6Quywb24iOsW913URv1IS4GD" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.2/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    
    <script>
    $(document).ready(function() {
        let url = 'http://localhost:3000/promociones'; // Actualiza la URL para que coincida con las rutas de tu controlador
        let opcion = null;
        let codigo, nombre, fechaInicio, fechaFinal, descuento, descripcion, estado, fila;

        //MOSTRAR
        let tablaPromociones = $('#TablaProm').DataTable({
            "ajax": {
                "url": url,
                "dataSrc": ""
            },
            "columns": [
                { "data": "codigo" },
                { "data": "nombre" },
                { "data": "fechaInicio" },
                { "data": "fechaFinal" },
                { "data": "descuento" },
                { "data": "descripcion" },
                { "data": "estado" },
                {
                    "defaultContent": "<div class='text-center'><div class='btn-group'><button class='btn btn-info btn-sm btnEditar'>Editar</button><button class='btn btn-danger btn-sm btnBorrar'>Borrar</button></div></div>"
                }
            ],
            "columnDefs": [
                {
                    "targets": [2, 3],
                    "render": function(data, type, row) {
                        return moment(data).format('DD/MM/YYYY');
                    }
                },
                {
                    "targets": 4,
                    "render": function(data, type, row) {
                        return data + '%';
                    }
                }
            ]
        });

        //CREAR
        $("#btnCrear").click(function(){
            opcion = 'crear';
            codigo = null;
            $("#formPromociones").trigger("reset");
            $(".modal-header").css( "background-color", "#23272b");
            $(".modal-header").css( "color", "white" );
            $(".modal-title").text("Crear Promoción");
            $('#modalCRUD').modal('show');
        });

        //EDITAR
        $(document).on("click", ".btnEditar", function() {
            opcion = 'editar';
            fila = $(this).closest("tr");
            codigo = parseInt(fila.find('td:eq(0)').text());
            nombre = fila.find('td:eq(1)').text();
            fechaInicio = moment(fila.find('td:eq(2)').text());
            fechaFinal = moment(fila.find('td:eq(3)').text());
            descuento = parseInt(fila.find('td:eq(4)').text());
            descripcion = fila.find('td:eq(5)').text();
            estado = fila.find('td:eq(6)').text();
            $("#codigo").val(codigo);
            $("#nombre").val(nombre);
            $("#fechaInicio").val(fechaInicio.format('YYYY-MM-DD'));
            $("#fechaFinal").val(fechaFinal.format('YYYY-MM-DD'));
            $("#descuento").val(descuento);
            $("#descripcion").val(descripcion);
            $("#estado").val(estado);
            $(".modal-header").css("background-color", "#4a4a4a");
            $(".modal-header").css("color", "white");
            $(".modal-title").text("Editar Promoción");
            $('#modalCRUD').modal('show');
        });

        //BORRAR
        $(document).on("click", ".btnBorrar", function() {
            fila = $(this);
            codigo = parseInt($(this).closest('tr').find('td:eq(0)').text());
            Swal.fire({
                title: '¿Confirma eliminar esta promoción?',
                showCancelButton: true,
                confirmButtonText: `Confirmar`,
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: url + '/' + codigo,
                        method: 'DELETE',
                        success: function() {
                            tablaPromociones.row(fila.parents('tr')).remove().draw();
                        }
                    });
                    Swal.fire('¡Registro Eliminado!', '', 'success')
                }
            })
        });

        //submit para CREAR y EDITAR
        $('#formPromociones').submit(function(e) {
            e.preventDefault();
            codigo = $.trim($('#codigo').val());
            nombre = $.trim($('#nombre').val());
            fechaInicio = $.trim($('#fechaInicio').val());
            fechaFinal = $.trim($('#fechaFinal').val());
            descuento = parseInt($.trim($('#descuento').val()));
            descripcion = $.trim($('#descripcion').val());
            estado = parseInt($.trim($('#estado').val()));
            if (opcion == 'crear') {
                $.ajax({
                    url: url,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        nombre: nombre,
                        fechaInicio: fechaInicio,
                        fechaFinal: fechaFinal,
                        descuento: descuento,
                        descripcion: descripcion,
                        estado: estado
                    }),
                    success: function(data) {
                        tablaPromociones.ajax.reload(null, false);
                    }
                });
            }
            if (opcion == 'editar') {
                $.ajax({
                    url: url + '/' + codigo,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        codigo: codigo,
                        nombre: nombre,
                        fechaInicio: fechaInicio,
                        fechaFinal: fechaFinal,
                        descuento: descuento,
                        descripcion: descripcion,
                        estado: estado
                    }),
                    success: function(data) {
                        tablaPromociones.ajax.reload(null, false);
                    }
                });
            }
            $('#modalCRUD').modal('hide');
        });
    });
    </script>
</body>
</html>
